<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
		
		<script type="text/javascript" src="js/ext/jquery-1.4.2.js"></script>
		<script type="text/javascript" src="js/ext/jquery-ui-1.8.5.js"></script>
		<script type="text/javascript" src="js/ext/jquery.scrollto-1.4.2.js"></script>
		<script type="text/javascript" src="js/lib/jquery.color-hash.js"></script>
		<script type="text/javascript" src="http://github.com/erisdiscord/jquery-plist/raw/master/lib/jquery.plist.js"></script>
		<script type="text/javascript" src="js/theme.js"></script>
		<script type="text/javascript">
			var currentTimeout;
			
			var participants = { };
			var messages     = [ ];
		
			var messageTemplate;
			var statusTemplate;
			
			(function() {
				
				$(document).ready(function() {
					$.ajaxSetup({ async: false });
					
					$.get('incoming/Content.html',
						function(html) { messageTemplate = html }, 'html');
					$.get('Status.html',
						function(html) { statusTemplate  = html }, 'html');
					
					$.get('Preview.plist', function(xml) {
						var conversation = $.plist(xml)
						
						$.each(conversation['Participants'], function(i, record) {
							participants[record['UID']] = record['Display Name'];
						});
						
						$.each(conversation['Preview Messages'], function(i, record) {
							var template  = messageTemplate;
							var classes   = [ record['Type'].toLowerCase() ];
							var uid       = record['From'];
							var sender    = participants[uid];
							
							switch ( record['Type'] ) {
							case 'Message': break;
							case 'Status':
								classes.push(record['Status Message Type']);
							default:
								template = statusTemplate;
							}
							
							if ( record['Autoreply'] ) classes.push('autoreply');
							if ( record['Outgoing']  ) classes.push('outgoing');
							else                       classes.push('incoming');
							
							messages.push({
								_template: template,
								messageClasses: classes.join(' '),
								time: record['Date'].slice(11, 19),
								senderScreenName: uid,
								sender: sender,
								message: record['Message'].replace(/<[^>]+>/ig, '')
							});
						});
						
					}, 'xml');
					
					
					mockup_dequeueMessage();
					
					$(window).bind('keydown', function(event) {
						switch ( event.which ) {
							case 32  : mockup_finish(true);  break;
							case 229 : mockup_finish(false); break;
						}
					});
				})
				
				function mockup_finish(animate) {
					while ( messages.length > 0 ) mockup_dequeueMessage();
					clearTimeout(currentTimeout);
					if ( animate )
						scrollToBottom();
				}
				
				function mockup_dequeueMessage() {
					var message = messages.shift();
					if ( message ) {
						var html = message._template.replace(/%(\w+)%/g, function(all, key) {
							return message[key];
						});
						
						checkIfScrollToBottomIsNeeded();
						appendMessage(html);
						scrollToBottomIfNeeded();
						currentTimeout = setTimeout(mockup_dequeueMessage, 1000);
					}
				}
				
			})();
		</script>
		
		<style id="mainStyle" type="text/css" media="screen">
				@import url(main.css);
				#source { display : none }
		</style>
	
	</head>
	<body>
		<header id="topic">This is a topic.</header>
		<div id="chat">
			<section class="file_transfer">
				<div class="meta" style="color: rgb(51, 163, 40); ">
					<div class="time alt">21:27:56</div>
					<div class="sender">Sig</div>
					<div class="sender_id">sigkimic</div>
					<div class="marker"></div>
				</div>
				<div class="content">
					<span class="file_name">greaseyrgranny.rtf</span>
					<button class="cancel"  data-handler="client.handleFileTransfer('Cancel', 'FileTransfer-3')">Cancel</button>
					<button class="save"    data-handler="client.handleFileTransfer('Save', 'FileTransfer-3')">Save</button>
					<button class="save_as" data-handler="client.handleFileTransfer('SaveAs', 'FileTransfer-3')">Save As&hellip;</button>
				</div>
			</section>
		</div>
		<footer id="footer"></footer>
	</body>
</html>
