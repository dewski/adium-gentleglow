<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
		
		<script type="text/javascript" src="js/ext/jquery-1.4.2.js"></script>
		<script type="text/javascript" src="js/ext/jquery-ui-1.8.5.js"></script>
		<script type="text/javascript" src="js/ext/jquery.scrollto-1.4.2.js"></script>
		<script type="text/javascript" src="js/lib/jquery.color-hash.js"></script>
		<script type="text/javascript" src="http://github.com/erisdiscord/jquery-plist/raw/master/lib/jquery.plist.js"></script>
		<script type="text/javascript" src="js/theme.js"></script>
		<script type="text/javascript">
			var currentTimeout;
			
			var participants = { };
			var messages     = [ ];
			
			var bodyTemplate;
			var headerTemplate;
			var footerTemplate;
			
			var messageTemplate;
			var statusTemplate;
			
			(function() {
				
				$(document).ready(function() {
					$.ajaxSetup({ async: false });
					
					$.get('Template.html', function(html) {
						// strip everything outside the body tag. gross.
						bodyTemplate = html.replace(/[\s\S]*<body[^>]*>|<\/body>[\s\S]*/ig, '');
					}, 'html');
					
					$.get('Header.html',
					  function(html) { headerTemplate  = html }, 'html');
					$.get('Footer.html',
						function(html) { footerTemplate  = html }, 'html')
					$.get('Incoming/Content.html',
						function(html) { messageTemplate = html }, 'html');
					$.get('Status.html',
						function(html) { statusTemplate  = html }, 'html');
					
					$.get('Preview.plist', function(xml) {
						var conversation = $.plist(xml)
						
						$.each(conversation['Participants'], function(i, record) {
							participants[record['UID']] = record['Display Name'];
						});
						
						(function() {
							var innerTemplates = [ headerTemplate, footerTemplate ];
							
							var chat   = conversation['Chat'];
							var source = chat['Source UID'];
							var dest   = chat['Destination UID'];
							
							var html = bodyTemplate.replace(/%@/g, function() {
								return mockup_fillTemplate(innerTemplates.shift() || '', {
									chatName:               participants[dest],
									sourceName:             source,
									destinationName:        dest,
									destinationDisplayName: participants[dest],
									outgoingIconPath:       'data:application/octet-stream,',
									incomingIconPath:       'data:application/octet-stream,',
									timeOpened:             chat['Date Opened'] // TODO parse this probably
								});
							});
							
							$('body').html(html);
						})();
						
						$.each(conversation['Preview Messages'], function(i, record) {
							var template  = messageTemplate;
							var classes   = [ record['Type'].toLowerCase() ];
							var uid       = record['From'];
							var sender    = participants[uid];
							
							switch ( record['Type'] ) {
							case 'Message': break;
							case 'Status':
								classes.push(record['Status Message Type']);
							default:
								template = statusTemplate;
							}
							
							if ( record['Autoreply'] ) classes.push('autoreply');
							if ( record['Outgoing']  ) classes.push('outgoing');
							else                       classes.push('incoming');
							
							messages.push({
								_template: template,
								messageClasses: classes.join(' '),
								time: record['Date'].slice(11, 19),
								senderScreenName: uid,
								sender: sender,
								message: record['Message'].replace(/<[^>]+>/ig, '')
							});
						});
						
					}, 'xml');
					
					mockup_dequeueMessage();
					
					$(window).bind('keydown', function(event) {
						switch ( event.which ) {
							case 32  : mockup_finish(true);  break;
							case 229 : mockup_finish(false); break;
						}
					});
				})
				
				function mockup_finish(animate) {
					while ( messages.length > 0 ) mockup_dequeueMessage();
					clearTimeout(currentTimeout);
					if ( animate )
						scrollToBottom();
				}
				
				function mockup_fillTemplate(template, params) {
					return template.replace(/%(\w+)%/g, function(all, key) {
						return params[key];
					});
				}
				
				function mockup_dequeueMessage() {
					var message = messages.shift();
					if ( message ) {
						var html = mockup_fillTemplate(message._template, message);
						
						checkIfScrollToBottomIsNeeded();
						appendMessage(html);
						scrollToBottomIfNeeded();
						currentTimeout = setTimeout(mockup_dequeueMessage, 1000);
					}
				}
				
			})();
		</script>
		
		<style id="mainStyle" type="text/css" media="screen">
				@import url(main.css);
				@import url(css/header.css);
				@import url(Variants/WhiteWashed.css);
		</style>
	
	</head>
	<body>
	</body>
</html>
